#!/usr/bin/env node
import { createSign } from 'crypto'
import dotenv from 'dotenv'
import { resolve } from 'path'

dotenv.config({ path: resolve(process.cwd(), '.env.local') })

const SCOPES = ['https://www.googleapis.com/auth/bigquery']

async function getAccessToken() {
  const email = process.env.GOOGLE_SERVICE_ACCOUNT_EMAIL
  const privateKey = process.env.GOOGLE_PRIVATE_KEY?.replace(/\\n/g, '\n')
  const now = Math.floor(Date.now() / 1000)
  const header = { alg: 'RS256', typ: 'JWT' }
  const payload = { iss: email, scope: SCOPES.join(' '), aud: 'https://oauth2.googleapis.com/token', iat: now, exp: now + 3600 }
  const encodedHeader = Buffer.from(JSON.stringify(header)).toString('base64url')
  const encodedPayload = Buffer.from(JSON.stringify(payload)).toString('base64url')
  const signatureInput = `${encodedHeader}.${encodedPayload}`
  const sign = createSign('RSA-SHA256')
  sign.update(signatureInput)
  const signature = sign.sign(privateKey, 'base64url')
  const jwt = `${signatureInput}.${signature}`
  const tokenResponse = await fetch('https://oauth2.googleapis.com/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({ grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer', assertion: jwt }),
  })
  return (await tokenResponse.json()).access_token
}

async function runQuery(token, sql) {
  const resp = await fetch('https://bigquery.googleapis.com/bigquery/v2/projects/master-roofing-intelligence/queries', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({ query: sql, useLegacySql: false, timeoutMs: 60000 })
  })
  return resp.json()
}

const SHEET_IDS = ["b8d49366c38e0a3425e014581bb4496d","09ce8ab81bd67312dd798905c82362f1","6a67ae5d3b6fccdc8d5b8449a6c7315b","59caaf26f9c1b1792bfd1c6556e9f459","7f028801c852e111ca0c42d43d1129b5","b4374f6cea368c71557e36db3cc5d47c","9a909f2d04e1d16298f57732efab7208","4f34b76a9a58eb7b1870111c8ad0c62d","050e82ea325b1159bbc42878c6f4868c","0d4da9803871c370f080587bad19aa9f","b01c9f28d8acb8f17c8fdcf2003c1ce5","0f802bd8dd34f150bfee8798e165bfa0","3c5c908d88906f68b362e6a327cfa135","03b3798570935143345ee8c0fab4af01","083b36d3756e1a1e8d3dd464a3f125ed","6eb2b457c2ed1ae463e78b0e469c2163","a0d351a864f6377e926e210f313203d2","9275fa7bb48e5f76f18d0f872631485d","b93aa01e780b7c4840ae1682dace330b","6267cd7a1cc37be59b278b7d23892520","91ccfeac0fc49576056cf558c512eff7","d1c09c27fe77333e0c09836ca844f15f","19a5f1e18c00de9d40094a6b5df6d117","3d2b7d0247cc70160aa155b9064b5260","72ddf1263f0ef825278be26c9b85838d","7432df4348a82b4f398335992907e057","7578b97ade637e25992255ee068092ae","6268f11e2b3fbb73bbb589ef295553d1","a9666a51c9e012c1d160524d0bf6ce1f","06c2e973f47023ed6c606b7e36f8348b","982c6266d0999ca5169630f7e14873d9","419ffd0fab98474e4c7931d7fc95e72c","16a8d9a4d3e7eef188d015bf2cf2622f","8570247d57f9f0d489d7a83b81546a6f","11bf2d7fa402dde9b074b51446f0dbf9","d7068b2564045993ea7ebc47abcc8ebc","73ebc481fe7ff05f8d0e97e8e9fc958e","555305f286dec3686be51af26f66e983","5e85f9050230eaaf4fb971dd771e70ed","d69f08328a466b60ff44853a836a9392","fda5ee73601c6c81a614fb36c68b9ed9","f94041312185e66f792ee0124020ac1a","e022ff095a4b7cd05650715127e9cc89","d4dd3757d1ea35f81acd29020253fdb5","c807f3d037c750308007acf62b5bc031","34bc8af88857636d66aedde7032a8dc2","8c78c22ebb91459fdc606d230ca4211b","e5fe65f6a636faa8cb79c98e2085fbcc","9219b0da347e04e4e99308de29322065","597c40741cddeec4fc761cfb082c11be","8f910c74f1c5002b655e91a13e437ba0","4b13ae4273c95a4c305da8a082875a8b","4ae973efc2aa71a3100fd1e92cd7c7a6","a788cbde405de0e7a9a91afc8a17a5c2","3c57f8ef11c106bc9c73641159871cb7","ee05fdc1cda5145e1c0fa3b6af5545c4","a108d9973d789fbb44eb1342cfecf7fb","051f3ff2d463aaf3e74dc3989a6fa781","5504b3e50d31eab3e49dc0c2c49f1b95","2e89e6ff40ed26d6caf7c6e27a049b50","19d2d5d8925ec3ac18c555cbd3d04eab","db6b19ff100b7552cd0e9e43874226e5","f94d879d7292bd1afb071efa31aa1508","cd66768641b6afd8c1fb0b20c9589ef2","ad7d4cc41fdcdc4f0fbe8f508befed12","6c592079184df92b6aadf0f79899baf2","28f02e967de003a45b124aeb6efa6a34","e3bdcdf1cf6092538be2f1a961c5cdc0","bd8f1985fca7e930b035a2748445dfd3","bd9a02554e887b2b8128334eccb09555","17cd78b8ea19eacaf84d1fb453f3d916","0ef0577c3b77455932565a927faf276a","d2563e04936e94544f4ec02094d0acaa","bcfef44f0f6239c7e4afabfce5241452","a0344f999842ba59f4581eb5c9d61b73","74a325d1a2083afdad86aa88c1c2828f","d0486d84dffbb02b79b738008e3c36f5","e40ce8e1c1b68c1ebcea509703f1a09c","fdd459d896e17d9454e77a5297ddb54a","3697577f68b8981c101dbda6b9dfd942","0a3909cdf9b1093da9163d86f9d084b6","757f8f4d716dc5e1d635ae49380e7d3f","0a4406dd9bd28f917b732f41e025c868","d893e1da7320a0368f5cc61588c6e4d8","17899e838271d6b69a1b121fc2aa0059","b1f744becf2e0656f40629dd72b9707c","8c274f25099b26cccb65cabcf8d9de94","5563dde710ebd842216979b42dd31783","3a1371533c0a0b420cb0197e17694632","385a6aeafbffc0f3a132056b0e3dcba1","003c6c7df66fb0a805423080932c1124","c3611a56d445332328226079ca78d0c8","b18570546b1e054998a6a6381deef720","f462793fefbd912a4f1acab98d1112e0","5f8003bf45d212002b0bae54c00f4162","2ad0776e54a92474061644a22d081fcf","20d9ee7c304431ef1819d21e9f4d26ac","20ba2549aca48ee646d50733fe39f5d0","047092d1950003b56617639c1fb69725","0bc1571b93f3ee47b2e25830f8645803","e7fd6657b012c2a6594f8f857716272e","adef1def20c307347c8fd31d75dbd9da","548228798d207d0f59679dd74b40204a","7ba6cdc4da82be965a6886137f1f5f32","c8eeecc98f3fc243d9d577e808575b1a","2ffe8b073cd76f046a206eb156454535","49b84c14aa740f9e0015d5d718e054c2","7d64fb003a864ae27ac9b63d936a4a3f","89021d4482c6d7223fc0a3c0540c28dc","59400b3b442fadfaa44dd2a933f3b6dd","3863e33cfee491b1340da6431335908a","0b827eec67028c1bbaae9b8f1301d71b","241e9681fd388fc9aefcebf4033d1eb4","f793782b0a13c4e09e050ef56ded30c0","afc3cc9bf05d9628a8431688511c8e3e","76a6ab260b24a061600f326916d70d66","ef9fbee9b21bc314bce6989cd92f2a2e","d0a0f5c36c76ad1f664617e34b755742","24ffaf80db8a353bc6571133db5a8ddb","e912244aa2e7d7c1258197a5ef6a92b9","704ea984dad0f1cdde982efc28545e03","4b98c533766cd91b25c57311b6d6585f","79f20f571abec94b307f743893382225","ba9dc3073d3b46b5217d1beff6e14264","daabba4a5ca668a98351b502f72e33df","6d7577830775a3f428f3bfa993162285","38c965bf1d9367063c52fb741bcef78c","c2bb28c923b08e11b69f0413f478ca49","f61c43ea44571b51ea1091c7792cd244","14c7718acbdf3d0b6614d01762657a12","a13de19f40b4d25945d56dbe401fc520","1851a068ffa522bdaec7d4904200d6b3","33d24acbb35b2407eeda8449a1bf9585","c73a6d76c1858c5db90aa1dff66187f1","2e5bdd2f7255993e5fc79c6ab0eb9e72","1f90ec295ab6fa2861e81b3a2dd3409b","d9f42364698623c28695828d571f2c3e","ceb97460cea1b9c35268693ed3a857c4","3f5039f813a0be0e2e388a5fa499de3e","607c72d4f80abbf991c8d765d62fcf9c","6dbbbc08ae4d6eaa3ed981bb5db372b5","e61292e3964a3794747144329d40284e","48b31f94169a23592ed428899a4daf54","3fd2cebd2b3f00150ff8e44700b696c5","e5ae7d9f09307722d19aef47fac44528","fc891f5ef7f3ca77e6b7eccf354cfc89","a7feb51d3716035e93ed5f4c518d7f81","fee75cde54677c34984c973fe460103a","0ccf941eddb35a102b696477c0138542","74e2754ae2df7f9ea5a9e7d82ecf316c","07f6e2fa5ab7fc3ffce2ef4da7328892","9b60ba0f6b907e41b13021f8a4aa881c","901a92d346d624ca12221a7ce219e9b6","2a8ae28ea92ab6adc30c73660b6ce98c","a413421956cdd386ccaf2228d66be553","f279c0b580612431600c738087e51b75","1332211650b6b512810104af1f370b75","1b678956707655ecbe84c08e8f921498","75544d0d1223f76c7fae6892aa48d670","fccf4fc78c1e0513de48bfef478c638a","4b9ad2f95ce30ef126e4634f51d57a6b","b4b143fd4c3c7f5e2cd807ef43606a20","bc9470f1dd87e3f803987a490532dc47","407890ec52be566dfc7beb2138293c5c","6e69a79f9f667f092391b94edee737bf","3bbadb0ebad2239da82885ca376d553c","66810d88fd7eec1e8db041e32f02b2d6","e06fd3688743e95261352f0d7dbe0bb2","61c519e47d6463a7d259530b6673bb57","3f00e27bb03261f7bf504f7da3ebed6d","8c707d0f8ec5d106ff91588c7b14af6b","4a1b37290e3a5ab84421faf515833ce0","a95d587f0f230cc0c827c956fcd7756c","ee5552705948c82ac1fd580f1c12a7f7","63b479ac8be32257c7897f99ce3d59ea","a78eeec3be79d20b974c5d0c177f311f","1f06336a44ec6fac76f0de59dbd5a8de","c26de9bee7260b42745b0380e007fb8c","dd697c638bf9802d7686daa300db54af","1ce810b2799329bfafc0f0908015ac21","7059377058cfbceb2cd8fe2b81984fa7","beccc7b4bc2e48b1481a61205ba80a51","4213a58bf5127f0d09ed9edec7436856","8e710da52dad3d3f6b03b866c516ba3b","7cec3beb25faf9385488956e24387b95","d8ad4f94c7b80aa8e44ad9a669ce495a","6b1dffa68ce27b415701d32685d640a6","a3b5178310444ccabcd41255cf194e6f","c309b1ac967a87742436c50cb356e7ba","0d08c19253d0e01863f399e2c4934d5e","ef1763cd31ba2a2fe1cc22b3ba7e4d57","8abc8936faeae3ea4c7fda85b78dddf2","9863ee9507cb7a815c87ec946021cdd8","a32b8e3187ea705cdef8164e691f1173","ee6c77f35744591858cf9368b4122172","017aa8d94cd32e08db38b081878cf286","0ff3d7950e720e0dd7624a62f406f18a","64df8971cfbcaa4d8dbedb667d85c556","a8838efe31c9c28dd9c5a60e25d2d80a","c546710d9dd3ac699394e5e0534cd926","6ef6a2316443f5c2d74a20737d46e37d","65cd50aa4850dc9a33f35c6e91b8a737","fa1dc461dfc31d6b08a53286cf5be2c2","28695df85cb5e12a331519d79a4768bc","ddf571d325f9f07409f4fe64bae09169","16641a9488a0dc6d864b04840e185b40","80fe73bf1c0932b2b89e4eb3422d9983","36b546cdc3a2ce2b8237334d82514f6f","8e4ad907790764ba0e11cebaa92eff12","bb8a4e1c231476998f06d69dd826aab9","9c6aa247aa8caa81c4e44fdd0874305d","58b8677eb7b213919847399f3d7ce7a3","b0835e0bfa9f209bdfba9cbf33883a55","14b4831fbaadf24bc01f6c99cfe021f5","d5c64516cbea5a02660b7c6c7ea8301e","a3a84a63d0dad62fe0609f583664308c","c125a06af13fd60e3cc1ff09d1b0d8e4","a166f82cabdc645347bfc491b01674f1","61a7196d5b9bdd24a1af03558c2d3950","06c66ff7c104dcec4c81a73320d28d7d","6559bdaff6faf70d78160c708b082ddc","29f1df5907f5b13464652a343e934c22","a20063166348a9e274e16d893b2e971c","42fc7371764e2008dc9dc028480f2756","d34a3d142b0b49bcf4b85093bed983b4","0fb9b914440df183f9894dc503536eb8","95f3b8d11475b3818d001975dbb78e42","93aaedea1224cad3bde3fd28fb40e4e2","494999c3257b7c6e2c098bc0ea79aab7","a0ae822374be1826c579286cf2cd584e","826a7d299ff062e7c6ff4d6e538cce5c","0272236c0e386272887ee71fb8bfbe7d","23cee3229c6b8bb5e6ecaac3c1e0e4de","e43b537728f5cf8275b6dd11a071352c","475770317224ab54f931943bd95f40c7","44240112308116ad5bdf1c49780d7e6c","f7fcd6a18b3c842ec37633458a5f6b1c","3b10ac2abce424b74594998477e9260d","124f7dc0f0d6b763d2822d442514e142","67d73f95ae45cf63b2ff7961b9592b3f","576c5de8a4b8890d23234c5f4d17ab57","63c311cbe9de6cc8e8f78faa8fc27a81","12cadf9eef99a6400ba7ab1937e5df61","a01cf8b27fe29000fdd79b3812b6170e","1c2e06208548e6b657ef5eb89bc6001a","1cafe1f2b25d8e6fe9861d658dd70a65","77867b6e1c6c27efdfca5895a6e8d999","48f9bca13a8f0d0948347dde331b513c","19eb38642a327513c0f1cfc72dda4195","4bf87392d040d34b409190f12eb6d6d4","dd069bb83f7ef2765993e88d7e3f540f","5bceb0e3cdfada531cf54bdbb379275c","08e038a7d110994b2758fde22f9cdc8a","9a55315b38f692787b19fd4205e95c81","94ccbb4b2247855bd0ad30ff2f98ac2f","875c80440f37cb277b4e3607a7ebbc8d","ed819e0ecce69038ee3b3ee108c9b505","741b68ae004d4ca528d425890f5c5392","7518410118f610924207eb2d88b58edc","b5ddcbe619c774b5e1021fd92f20a8c4","885f2576cec192baf53982097eefcfb0","cd99ed1185d234ae0fa02e6b4dbca318","5f90ff7f03dd54006405b5f7db67e88f","76464ece967815fdf6a784dce8ca7326","a62a8aca87b5c83dffb1384abf393d5c","a34a3b19c7f5470a34c9c63a302eb546","f9e8ce46184835a2f6eff0608c315db7","fb8a4f586a91acba90be907bc6a47771","658f9cfb066fe987b1bf3e10f1829fb9","13c98a63dfc7e6509f9dba0385b76208","2e8902174fbcc2b3af63e392aa8bc2f6","fdb1c24c22c0aa4b540ed09fa2b6fdd6","c99fbe825f90550cef1101485f09d803","b3bed4eb2410dfc698dd75256cdc0312","f2debf7c9d2ee08d51dacc5df32b8c60","f1ff15a8a1d7c8e10783c854a4156e76","37fa491913d6befc0a337d782391b9ca","445bd2e20fcbaa94c9ed1b7e7bbf20bd","4e9105f1064abbcb8d3b96070e6160de","de82f427428b4c11db9a28ed7e1a7ee0","ba32fd54199fc7b66d5cdae957f47e2d","249a95512dea8daa17302fe7131d41f8","d647261a85406aec45a543e7da2bd651","f4270c38685739470235fae8d7fbf417","ea3ea8a1638cf5d3c63bd9a51f4313e8","8727fb5ee96aab437ffacfb4be431c9f","2fcaaca7be529b51e31b342899e985e9","17957d85413a90719ce51a4850f4cc69","979075dd4ab50e0dfc48f1789ded00c9","f0fa9c7acecd8d9ad720632ec1058ba9","5434e9a3173d3f8c952d4575a552a59f","d7b8ac7023b855fced8faafefc2aa611","d81680a0632e2f5db75b04f82a526d2a","2caedd4adcac1b62852404d5497ab9ed","1f9658412fbcc822516a48b8c48639d0","16ae4c848cf3dcae695de97b3aaa373d","584ff200b310d862411589de19b4fafd","65326c6894b03e47c93d1aac6c1744ee","b9b60345f624029311356820308d5dd8","d9c5f39a5132d9215d14eb15ce97b277","8f0d08841fe2ac20545a4e462cc06cf1","bab59a06c25b2d941e0e698ef8180300","abadd41b2dfa7e4a6c71cea70ed439aa","382be1ef91d874fd3ba15aa712d53896","0225e2236808a6db746caf20b2a72f5e","a8539d0f1c0b8ebb359b4fcb052c4dac","0704c7782b5e30b9b6f6f64c0c77aaf9","07f9e9106731940280a3aae38e51c8ba","9fd7dd92bd7d27639ff05e6bdb15c0d2","68f15d43942fccea9b841c4f330e57b2","adf84e6855c65aea53a12e38e70e0add","6745755633bfc9797a0d25f7bd99cd23","5049dd9c458c80e2aee5684d2cae48c4","ef01aca8bbc838beade2e6ca22735e16","d516fb120e9c0a6f9adfd637496d8f76","0937c99cc0cce4b07aefef150873153e","20c14c7a67708b3a239416cf3fde045a","6b0516e05a61b5976c350550adeb7cd8","2b023b26d94267870ef67fbd2cf4da74","cbc2660d962088311c413a721c383654","e038955f7d1693d655a3a6023cae6d56","6633ee6a8bc500e4672d2318f789c7bd","ca7763b99a1b3c05fd107aeca88f19d8","0ac76335df8ddb5d8ec262152353b8fc","43a686edd463a2a7c7af7876b883de48","385501b92d04262c67f1b49c9288009f","4e2b91cbeefa0dc65e87685af2a5b31f","02144863f1a8522bd5e692476fb26062","f54104d9bd8c2710b6ad3fefdbce8fa1","86ac34b731817bb290f72a71ae72ef0b","58f3ba238f8a0c94e0bd8ac44633f58a","646fec4e74619ebdff74340af8fb57d7","e1ed76728f5f5962ac25a50557226f4a","d85240e094b1958a04554758bc29d157","d03f2d566b1455f7c9cb492533e37050","a7bdb87683a74df1479a3e774bd33885","04e26ffa11e5f87f5b7db03eb1d33134","10b5d7a2ece7b045820802753f75707f","e8d38cc72237381778ddb717142467d1","6fc247327b29174202bc54e20ffbf414","ef0eb4ef4ebc2cc2aa6602561e46a998","3ed1a3e6ec1754d6a8a790ffc66c1563","082c0b67a1a347cd4a3f63e154d16de1","2ce0cd00b53d5a84bd50334c14d5727e","cce911f44ea171c87f45541dfbda2167","256a1663b188177f015381d477663207","d644d709557292d45f78e670ecf32677","8dc478ec05089818d124834bfe264a2a","5193dc43846da38f61b1fe1a5e209bdf","c871f456d019970455119fd9b155acbc","e6fd11a63dd40dde8cf8cf03e524fcb8","19127759138ec3e33f5f336257beff37","2959c3ddf7302743ca08401489669605","af4aeaed6547f81ec4705aa95e739dd3","f4f11123995c8b7c4c0a65de331f6566","599e9e7f9f676b91eb83ddc3810f6378","661cc934fbe711db26d2006adcb73b77","cb90503c9bbe794f143082e4e0e96f19","bc55b8134592dea425ceeb887358a1c2","230a34b2d396372c2666106267a9ce77","725df96dce7149f206b1b821a93c8409","8baf43154d39e994fea8951f30dfecd9","b7ae00f170171246ef9edf21650d9389","955d1f28c3c865c16baa59b40dbfd214","87c18146d2cf473cc25e01747696adba","05d41f27a238d32b1ab847b3ba44f3f6","18d1737f37c85a054a15f830087d9922","7287375bd4f4a03f8442f578331d9cc8","c90ed4c04537768b53ca04439145ab89","e4ae27990c2ca24ba8c315845dd0b4b1","5035d5b1b37927ac99e00946c83872cb","d3a6f2d739a6105b2d5838227522f0e1","c707f9b383c79e1e031b359a52c925f9","e006601d1e342e8d9d54f380a9c65431","e14ca367d842dcbc9a7c75ebf14f29f3","c354f09b201b5844048c78564a9c0061","bd51c1570e2f1d25681a601d3064ca7f","e373520e776a858e7271ca7467f27a0b","10e2f9068aa92beb76ae41d6c6ec4e56","c9ee871fdf22a00946784ba12ce6453a","57fe83b12e1f4ffd34fa699709b63bc2","9e728f176453fd9f8bfc3bc84285efa4","e5e7ff86733616f0cc57f9c9baa890cb","0841af8d83fb84fa7f5ee12c62a23d09","1a97fd8aba0ee52e22b9569860671ca6","3149bc6e8a6b1205ff9b4c8007b398f1","df4d5fdcb92a6f218d76f6206e2f8edd","8fc0943c848400d5aa757d1aafed006f","35565dee383990f6bbdb172b91f8d8a9","cc589c3466a96e54a86948d429f04ce6","ab97b7d9d01f18d9c2c43605c7fa6903","fab2ddc4b52f632ed21162339b903bbf","50318add843ea8bd25ab93cfc3dd3eba","0fa1b99c81110ba7f5dac61047f75b64","b60787a638b47334b65a2552e7afca6a","0a1e103c8e9e0b2746300da2f38ca01f","e4d925e921257d080058edd645581be1","d20c11470cfd0c6b476870bab33f3ae1","493a5e77ca2b08882ef741c769d4f930","38d5077d426837e68a02ba1e33beacfe","5773439448c3ff96b730fea9b44291fe","22dbe359ebcf4c8efaef2c8f075b256f","22d7938a04f8370d5c4746ce21fdf84e","e7b9c630115be06f90e40543e4ab5870","ebc75948a13fbe07b562fa020dc0a54f","ebd1fe0c2618428b9814f224ba028f6a","4bf9e6cd9aeb7e19ddff41d93c818666","246c51f907729b3001f63b1a7209cd86","9c76ae8b59107cff5fdcfaf0d705a340","a7297d1944a3fa3e96b5e8acc19a1e04","a2d648bf2b92df7f1d80e88059485a2f","9a7f1c21d9c617c5e7653e93e1d6ebc1","70f52f5e3ea4de9da47b4afb93241c11","792a2dbb5bcfaa69207e30071a326e99","4a597df5f26d428e672b712d35b88f62","be7947252d9ca364493f50761a0da440","5d23fd005ad8ea4f73f1147d31aba4eb","02c509e109264ef8ab4650519c888e80","19f9392a66f6276d5e86607fc9c0b021","4a2bf47dc3d816c38560257f0bd3b60b","0be4619a2cddb8162adb263c7e096515","a30e61d9810c3ed6b66ba8516be51fd0","06fc388c3daa04a8cafeef75ddcad0ad","6c3d5ba74309e091a32384014cb5ec18","3ddbd2971fe34193eaf2fca1d28b76b6","b2605567b589543aad5b383001344fd1","b6a01c64468fb93e3f38e24f6744b87e","25deab105c60ef3d75bbdd41ec2a8f39","54dd669d70f919cf801cf751017a4141","5819d9b2e9469230827784f9150e32db","d064aedf2178d5ff6d6ba82a4e5da079","e04272fb4a54bd51ff9da4de4d792dc7","4dec75f29560c6d4f3f74e619e8215e1","8f840071df9adefd7e9f98279e84a13c","e7f1c41a4c7b34c73930b47ab4c10234","f8d4cfbca582b15bffb04004dc4fcc71","770cf18ff4e8f6988875ff3acef5b76e","4350e6bdf8119a1f6fcf9dd770a46b3a","e1667998b4efab2ec598b48261b3a5b6","01e59ccba322b2a7aa20a980298f86d0","f8548498736b2f3e10c39f4b7465fca5","1ca930d256059fd50674ddd50e0519ba","c2a4f3aac241b525e0851489544111bd","76ea92f642bfa2383e66a0350c423788","b191cfc1a9c6488df352e197a2293b68","e23ddd780250a6db7e9fea9d0db5cf95","95016bd6906d55d800d19a0328e13499","4d1018ac598700b37d86def1aa2c61d0","ed1a50be869d6c93f0ce223b01d73c6d","fe0097f2ad2cf7a022e0903022cdf1dc","0027f9f8c5ee1ac3756657ed6142ef6f","9de7c0510ca53e7f25372446aad81676","db7f1033c16c5fee8f6136740768bb47","f45ae5c54d3593e982a6663b6de673b7","bd9e8771eec1ead3b5f9de825350f5c1","31b83ea9b2ab62a948c35dd8f5cecc34","027f7ec2a271c82e167d67fa73121d46","6c30926d64555ca2b2d4bf0055f0c364","7c944902f54d25f3a88e70dca931e71d","120dc9911a64b043be100a81d222a5fc","dd42d165a3c080a9684eaa048395f253","5a760b95adf106f3d924f6c71ae509bf","bf10cf33bc8bfd60b54e66bbb57c32a1","4752985e4650e2d8c4aa53e650601750","064a04ccf30ff8b51aabfabcd90c8b49","ce4100bcdf548389dacad0572b43154b","2a41eb49acd93ad09c579c4957c148ac","02aac340a9bbb04de7c09cf97100aa27","5844bc73ca3a840514e166de32a28f60","047ff22345eed96538c833e45c77f65e","f606edfc7b84e44dc25385b6b7dfd16b","18f0036c390e75e9c0fab7ce014bddeb","3e798ee2f0aa175d5e288db027714b55","b657e75b957f570d0ae0fad9c2c848c0","81b10aefecf55f66c912f7953b2c1d80","0366c8332c56389f646ea0a341b78307","53321aad4bab5eb36b89972fb1d337f0","604c4f98f460849abb71c94cdc1d43f4","0196816c61466f8e511e3c0999aa4a4e","6c24531160fa9b33d6c21604e35fe636","9b21910dc429435b307bb712b0f9e982","e4f052e7e40698031f95d5c14549ff26","e4d25d9ba1354605f005608e5c43a0df","267498f65ad2e5b4064453373bded9d2","17765529aff2b450e04dbfa16edd50a7","9aec861f31c07e5e04b7fd04199037ef","a0aa08035959a7007432301cbc2028f5","680f791dd47e6d720dfc0b285c0d9c5b","5d56a0ac36598c8cbddbd0d7686d9540","52ecb5863b84d02db838d365027527f1","251f9f82e54a52ff028bb82f78511f36","3d5efb49c489a4a9b1644625c186bf14","9613f4e030f292589fa2d8b52d8d8da2","cb8e191de47696ca655bd28e1b2e17ce","75038c68509ed815138094cf5cb97982","188ac343c546a1fa365055bc27e82be1","8b90bb727cffcccf3c02da3487a3d3bc","d3c6478f083217aa39b97fc26fa81804"].filter(x => x)

async function main() {
  const token = await getAccessToken()
  
  // Find tables with project in name
  console.log('=== Checking available project tables ===')
  for (const dataset of ['raw_data', 'identity_resolution', 'semantic', 'mr_core']) {
    const result = await runQuery(token, `
      SELECT table_name FROM \`master-roofing-intelligence.${dataset}.INFORMATION_SCHEMA.TABLES\`
      WHERE LOWER(table_name) LIKE '%project%'
    `)
    if (result.rows?.length > 0) {
      console.log(`\n${dataset}:`)
      result.rows.forEach(r => console.log('  -', r.f[0].v))
    }
  }
  
  // Check identity_resolution.canonical_projects
  console.log('\n=== Checking canonical_projects ===')
  const cpSchema = await runQuery(token, `SELECT column_name FROM \`master-roofing-intelligence.identity_resolution.INFORMATION_SCHEMA.COLUMNS\` WHERE table_name = 'canonical_projects'`)
  if (cpSchema.rows) {
    console.log('Columns:', cpSchema.rows.map(r => r.f[0].v).join(', '))
  }
  
  // Count matches
  const idsString = SHEET_IDS.map(id => `'${id}'`).join(',')
  const matchQuery = `
    WITH sheet_ids AS (SELECT id FROM UNNEST([${idsString}]) AS id)
    SELECT 
      (SELECT COUNT(*) FROM sheet_ids) as total_sheet,
      (SELECT COUNT(*) FROM \`master-roofing-intelligence.identity_resolution.canonical_projects\` cp 
       WHERE cp.project_id IN (SELECT id FROM sheet_ids)) as matched
  `
  const matchResult = await runQuery(token, matchQuery)
  if (matchResult.rows) {
    console.log('\nSheet IDs:', matchResult.rows[0].f[0].v)
    console.log('Matched in canonical_projects:', matchResult.rows[0].f[1].v)
  } else if (matchResult.error) {
    console.log('Error:', matchResult.error.message)
  }
}

main().catch(console.error)
